<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Recommender (TMDb + Slider Year Range + Table Output)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <style>
      @font-face {
        font-family: 'LucideIcons';
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide {
        font-family: 'LucideIcons';
        font-size: 1.25rem;
        line-height: 1;
        display: inline-block;
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f3f4f6;
      }
      #results {
        overflow-y: auto;
        overflow-x: auto;
      }
      #results::-webkit-scrollbar { width: 8px; height: 8px; }
      #results::-webkit-scrollbar-track { background: #e5e7eb; border-radius: 10px; }
      #results::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
      #results::-webkit-scrollbar-thumb:hover { background-color: #6b7280; }

      #message-box {
        position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
        padding: 12px 20px; border-radius: 8px; color: white; font-weight: 500;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); z-index: 1000;
        display: none; opacity: 0; transition: opacity 0.3s ease-in-out;
      }
      #message-box.show { display: block; opacity: 1; }
      #message-box.info { background-color: #3b82f6; }
      #message-box.error { background-color: #ef4444; }

      .movie-poster-table {
        width: 40px; height: 60px; object-fit: cover;
        border-radius: 4px; background-color: #e5e7eb;
        display: block; margin: auto;
      }
      .provider-list span {
          display: inline-block; margin-right: 6px; margin-bottom: 4px;
          padding: 2px 6px; background-color: #e5e7eb; border-radius: 4px;
          font-size: 0.7rem; line-height: 1.2;
      }
      /* Basic Table Styling */
      .results-table { min-width: 100%; border-collapse: collapse; }
      .results-table th, .results-table td {
          border: 1px solid #e5e7eb; padding: 8px 12px;
          text-align: left; vertical-align: top; font-size: 0.875rem;
      }
       .results-table th { background-color: #f9fafb; font-weight: 600; white-space: nowrap; }
       .results-table td { background-color: #ffffff; }
       .results-table tbody tr:nth-child(even) td { background-color: #f9fafb; }
       .results-table .col-poster { width: 60px; text-align: center; }
       .results-table .col-year { width: 80px; text-align: center; }
       .results-table .col-rating { width: 110px; }
       .results-table .col-lang { width: 80px; text-align: center; }
       .results-table .col-providers { min-width: 150px; }

       /* noUiSlider Customization (Optional) */
       .noUi-target {
           border: 1px solid #d1d5db; /* Gray-300 */
           box-shadow: none;
           background: #e5e7eb; /* Gray-200 */
           border-radius: 9999px; /* pill shape */
           height: 8px;
       }
       .noUi-connect {
           background: #4f46e5; /* Indigo-600 */
       }
       .noUi-handle {
           border: 1px solid #d1d5db; /* Gray-300 */
           border-radius: 50%;
           background: #ffffff; /* White */
           box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
           cursor: grab;
           width: 10px;
           height: 10px;
           right: -1px; /* Center handle */
           top: -1px; /* Center handle */
       }
        .noUi-handle:focus { outline: none; } /* Remove focus outline */
        .noUi-handle:active { cursor: grabbing; }
        .noUi-handle::before, .noUi-handle::after { display: none; } /* Hide default pseudo-elements */

        /* Styling for slider value display */
        .slider-values {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.875rem; /* text-sm */
            color: #4b5563; /* Gray-600 */
        }

    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-indigo-100 via-purple-100 to-pink-100">

    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg w-full max-w-4xl">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6 sm:mb-8 flex items-center justify-center gap-2">
            <span class="lucide">&#xea5c;</span> Movie Recommender
        </h1>

        <form id="recommendation-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-6 mb-6 sm:mb-8">
            <div>
                <label for="genre" class="block text-sm font-medium text-gray-700 mb-1">Genre</label>
                <select id="genre" name="genre" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="">Any</option>
                    </select>
            </div>

            <div>
                <label for="tmdb-rating" class="block text-sm font-medium text-gray-700 mb-1">Min TMDb Rating (0-10)</label>
                <input type="number" id="tmdb-rating" name="tmdb-rating" min="0" max="10" step="0.1" placeholder="e.g., 7.0" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
            </div>

            <div class="md:col-span-1">
                <label class="block text-sm font-medium text-gray-700 mb-1">Release Year Range</label>
                <div id="year-slider" class="mt-2 mb-1"></div> 
                <div class="slider-values">
                    <span id="start-year-display">1990</span> 
                    <span id="end-year-display">2020</span>  
                </div>
            </div>

            <div>
                <label for="language" class="block text-sm font-medium text-gray-700 mb-1">Original Language</label>
                <select id="language" name="language" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="">Any</option>
                    </select>
            </div>

            <div>
                <label for="country" class="block text-sm font-medium text-gray-700 mb-1">Country of Origin</label>
                <select id="country" name="country" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    <option value="">Any</option>
                    </select>
            </div>

            <div> 
                <label for="watch-country" class="block text-sm font-medium text-gray-700 mb-1">Watch Region (for Providers)</label>
                <select id="watch-country" name="watch-country" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm">
                    </select>
            </div>

            <div class="md:col-span-2 lg:col-span-3 flex justify-center mt-4">
                <button type="submit" id="find-button" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="lucide">&#xea7e;</span> Find Movies
                </button>
            </div>
        </form>

        <div class="mt-8">
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4 text-center">Recommendations</h2>
            <div id="results" class="bg-gray-50 p-1 sm:p-2 rounded-lg border border-gray-200 min-h-[200px] max-h-[400px] overflow-y-auto overflow-x-auto">
                <p class="text-center text-gray-500 p-4">Enter your preferences and API key, then click "Find Movies". Results will be shown here as a table.</p>
            </div>
        </div>
    </div>

    <div id="message-box"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>

    <script>
        // --- TMDb Configuration ---
        // ðŸš¨ IMPORTANT: Replace 'YOUR_TMDB_API_KEY_HERE' with your actual TMDb API key.
        // ðŸš¨ WARNING: Exposing API keys in client-side code is insecure for production apps.
        const apiKey = '1897ffc0a507fadb98e68392bca2efd1'; // <-- PASTE YOUR KEY HERE
        const tmdbBaseUrl = 'https://api.themoviedb.org/3';
        const imageBaseUrl = 'https://image.tmdb.org/t/p/w200';

        // --- Mappings --- (Unchanged)
        const genreMap = { "Action": 28, "Adventure": 12, "Animation": 16, "Comedy": 35, "Crime": 80, "Documentary": 99, "Drama": 18, "Family": 10751, "Fantasy": 14, "History": 36, "Horror": 27, "Music": 10402, "Mystery": 9648, "Romance": 10749, "Sci-Fi": 878, "TV Movie": 10770, "Thriller": 53, "War": 10752, "Western": 37 };
        const languageMap = { "English": "en", "Spanish": "es", "French": "fr", "German": "de", "Japanese": "ja", "Korean": "ko", "Hindi": "hi", "Mandarin": "zh", "Italian": "it", "Portuguese": "pt" };
        const countryMap = { "Australia": "AU", "Brazil": "BR", "Canada": "CA", "China": "CN", "France": "FR", "Germany": "DE", "India": "IN", "Italy": "IT", "Japan": "JP", "Mexico": "MX", "Netherlands": "NL", "South Korea": "KR", "Spain": "ES", "Sweden": "SE", "UK": "GB", "USA": "US" };
        const watchRegionMap = countryMap;

        // --- DOM Elements ---
        const form = document.getElementById('recommendation-form');
        const resultsDiv = document.getElementById('results');
        const genreSelect = document.getElementById('genre');
        const tmdbRatingInput = document.getElementById('tmdb-rating');
        // Removed startYearInput, endYearInput
        const languageSelect = document.getElementById('language');
        const countrySelect = document.getElementById('country');
        const watchCountrySelect = document.getElementById('watch-country');
        const messageBox = document.getElementById('message-box');
        const findButton = document.getElementById('find-button');
        const yearSliderElement = document.getElementById('year-slider'); // New slider element
        const startYearDisplay = document.getElementById('start-year-display'); // New display element
        const endYearDisplay = document.getElementById('end-year-display');   // New display element
        let messageTimeout;

        // --- Global variables to store current slider values ---
        let currentStartYear = 1990; // Default start year
        let currentEndYear = 2020;   // Default end year

        // --- Populate Select Options --- (Unchanged)
        function populateSelect(selectElement, map, defaultValue = null) {
            const sortedEntries = Object.entries(map).sort((a, b) => a[0].localeCompare(b[0]));
            sortedEntries.forEach(([name, value]) => {
                const option = document.createElement('option');
                option.value = value; option.textContent = name;
                if (value === defaultValue) { option.selected = true; }
                selectElement.appendChild(option);
            });
        }
        populateSelect(genreSelect, genreMap);
        populateSelect(languageSelect, languageMap);
        populateSelect(countrySelect, countryMap);
        populateSelect(watchCountrySelect, watchRegionMap, 'US');

        // --- Initialize Year Range Slider ---
        const currentFullYear = new Date().getFullYear();
        noUiSlider.create(yearSliderElement, {
            range: {
                'min': 1900, // Minimum possible year
                'max': currentFullYear // Maximum possible year
            },
            start: [currentStartYear, currentEndYear], // Initial handle positions
            connect: true, // Connect handles with a colored bar
            step: 1, // Step by 1 year
            margin: 1, // Minimum distance between handles (optional)
            format: { // Format values as integers
              to: function (value) { return Math.round(value); },
              from: function (value) { return Number(value); }
            }
            // tooltips: [true, true] // Alternative: use built-in tooltips
        });

        // --- Update display and variables when slider changes ---
        yearSliderElement.noUiSlider.on('update', function (values, handle) {
            const startVal = parseInt(values[0]); // Get integer value
            const endVal = parseInt(values[1]);   // Get integer value

            startYearDisplay.textContent = startVal; // Update start year display
            endYearDisplay.textContent = endVal;     // Update end year display

            // Store current values globally for form submission
            currentStartYear = startVal;
            currentEndYear = endVal;
        });


        // --- Utility Functions --- (showMessage, fetchWatchProviders unchanged)
        function showMessage(message, type = 'error', duration = 4000) { /* ... */ }
        async function fetchWatchProviders(movies) { /* ... */ }


        // --- Display Results Function (Table Format) --- (Unchanged)
        function displayResults(movies, watchCountryCode) { /* ... */ }


        // --- Form Submission Event Listener --- (Updated Year Handling)
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            if (apiKey === 'YOUR_TMDB_API_KEY_HERE' || !apiKey) {
                showMessage('Please enter your TMDb API key in the script section first.', 'error');
                return;
            }

            // --- Get User Inputs (Rating, Genre, Lang, Country, Watch Region) ---
            const selectedGenreId = genreSelect.value;
            const minTmdbRating = parseFloat(tmdbRatingInput.value) || 0;
            const selectedLangCode = languageSelect.value;
            const selectedCountryCode = countrySelect.value;
            const selectedWatchCountryCode = watchCountrySelect.value;

            // --- Get Year Range from Slider (using global variables) ---
            // Validation is implicitly handled by the slider's range and step
            let releaseDateGte = `${currentStartYear}-01-01`;
            let releaseDateLte = `${currentEndYear}-12-31`;

            // --- Start API Fetch Process ---
            findButton.disabled = true;
            findButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">...</svg> Finding movies...`;
            resultsDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Finding matching movies...</p>';

            // Construct the TMDb Discover API URL
            const discoverUrl = new URL(`${tmdbBaseUrl}/discover/movie`);
            discoverUrl.searchParams.append('api_key', apiKey);
            discoverUrl.searchParams.append('include_adult', 'false');
            discoverUrl.searchParams.append('include_video', 'false');
            discoverUrl.searchParams.append('language', 'en-US');
            discoverUrl.searchParams.append('sort_by', 'vote_average.desc');
            discoverUrl.searchParams.append('vote_count.gte', 100);

            // Add parameters based on user selections
            if (selectedGenreId) discoverUrl.searchParams.append('with_genres', selectedGenreId);
            if (minTmdbRating > 0) discoverUrl.searchParams.append('vote_average.gte', minTmdbRating.toFixed(1));
            // Use slider values for date parameters
            discoverUrl.searchParams.append('primary_release_date.gte', releaseDateGte);
            discoverUrl.searchParams.append('primary_release_date.lte', releaseDateLte);
            if (selectedLangCode) discoverUrl.searchParams.append('with_original_language', selectedLangCode);
            if (selectedCountryCode) discoverUrl.searchParams.append('with_origin_country', selectedCountryCode);

            let initialMovies = [];
            try {
                // --- Stage 1: Discover Movies ---
                const response = await fetch(discoverUrl);
                if (!response.ok) {
                    let errorMsg = `Error finding movies: ${response.status} ${response.statusText}`;
                    try { const errorData = await response.json(); if (errorData.status_message) errorMsg = `TMDb Error: ${errorData.status_message}`; } catch (e) {}
                    throw new Error(errorMsg);
                }
                const data = await response.json();
                initialMovies = data.results;

                if (initialMovies.length === 0) {
                     displayResults([], selectedWatchCountryCode);
                     findButton.disabled = false;
                     findButton.innerHTML = `<span class="lucide">&#xea7e;</span> Find Movies`;
                     return;
                 }

                // --- Stage 2: Fetch Watch Providers ---
                findButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">...</svg> Fetching providers...`;
                resultsDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Fetching watch provider information...</p>';

                const moviesWithProviders = await fetchWatchProviders(initialMovies);
                displayResults(moviesWithProviders, selectedWatchCountryCode);

            } catch (error) {
                console.error("API Fetch Error:", error);
                showMessage(`Failed to process request. ${error.message}`, 'error');
                resultsDiv.innerHTML = `<p class="text-center text-red-600 p-4">Error loading recommendations. Check console for details.</p>`;
            } finally {
                 findButton.disabled = false;
                 findButton.innerHTML = `<span class="lucide">&#xea7e;</span> Find Movies`;
            }
        });

        // Set the initial placeholder message
        resultsDiv.innerHTML = '<p class="text-center text-gray-500 p-4">Enter your preferences and API key, then click "Find Movies". Results will be shown here as a table.</p>';

    </script>
    <script>
        // Function bodies are included here in the actual execution context
        // Displays messages (errors or info) to the user
        function showMessage(message, type = 'error', duration = 4000) {
            messageBox.textContent = message;
            messageBox.className = ''; // Clear previous type classes
            messageBox.classList.add('show', type); // Add 'show' and the type ('error' or 'info')
            if (messageTimeout) clearTimeout(messageTimeout); // Clear existing timeout if any
            // Set timeout to automatically hide the message
            messageTimeout = setTimeout(() => { messageBox.classList.remove('show'); }, duration);
        }

        // Fetches watch provider information for an array of movies
        async function fetchWatchProviders(movies) {
            // Create an array of fetch promises
            const providerPromises = movies.map(movie => {
                const providerUrl = `${tmdbBaseUrl}/movie/${movie.id}/watch/providers?api_key=${apiKey}`;
                return fetch(providerUrl)
                    // If response is ok, parse JSON, otherwise return null
                    .then(response => response.ok ? response.json() : null)
                    // Catch network errors and return null
                    .catch(error => {
                        console.error(`Error fetching providers for movie ${movie.id}:`, error);
                        return null;
                    });
            });

            // Wait for all promises to settle (either succeed or fail)
            const results = await Promise.allSettled(providerPromises);

            // Map original movies, adding provider data if fetch was successful
            return movies.map((movie, index) => {
                // Check if the promise was fulfilled and returned data
                movie.watchProviders = (results[index].status === 'fulfilled' && results[index].value)
                    ? results[index].value.results // Assign provider results
                    : null; // Assign null if fetch failed or returned null
                return movie;
            });
        }


        // --- Display Results Function (Table Format) ---
        // Renders the list of movies as an HTML table
        function displayResults(movies, watchCountryCode) {
            resultsDiv.innerHTML = ''; // Clear previous results or loading message

            // Handle case where no movies are found
            if (!movies || movies.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-gray-500 p-4">No movies found matching your criteria to display in the table.</p>';
                return;
            }

            // Create the main table element
            const table = document.createElement('table');
            table.className = 'results-table w-full'; // Apply styling classes

            // Create the table header (thead)
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            // Define table headers (dynamic watch country header)
            const headers = ['Poster', 'Title', 'Year', 'Rating', 'Lang', `Watch (${watchCountryCode})`];

            // Populate header cells (th)
            headers.forEach((text, index) => {
                const th = document.createElement('th');
                th.textContent = text;
                // Apply specific column classes based on index
                if (index === 0) th.classList.add('col-poster');
                if (index === 2) th.classList.add('col-year');
                if (index === 3) th.classList.add('col-rating');
                if (index === 4) th.classList.add('col-lang');
                if (index === 5) th.classList.add('col-providers');
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create the table body (tbody)
            const tbody = document.createElement('tbody');
            // Loop through each movie to create a table row
            movies.forEach(movie => {
                const row = document.createElement('tr');

                // --- Create Table Cells (td) for each movie ---

                // 1. Poster Cell
                const cellPoster = document.createElement('td');
                cellPoster.classList.add('col-poster'); // Apply column style
                const posterImg = document.createElement('img');
                posterImg.className = 'movie-poster-table'; // Table-specific poster style
                posterImg.src = movie.poster_path ? `${imageBaseUrl}${movie.poster_path}` : 'https://placehold.co/40x60/e2e8f0/cbd5e0?text=N/A'; // Placeholder image
                posterImg.alt = `Poster`; // Simple alt text
                // Fallback for broken images
                posterImg.onerror = function() { this.onerror=null; this.src='https://placehold.co/40x60/e2e8f0/cbd5e0?text=Err'; };
                cellPoster.appendChild(posterImg);
                row.appendChild(cellPoster);

                // 2. Title Cell
                const cellTitle = document.createElement('td');
                cellTitle.textContent = movie.title || 'N/A'; // Movie title
                cellTitle.classList.add('font-medium', 'text-gray-900'); // Styling
                row.appendChild(cellTitle);

                // 3. Year Cell
                const cellYear = document.createElement('td');
                cellYear.classList.add('col-year'); // Apply column style
                // Extract year from release_date string
                cellYear.textContent = movie.release_date ? movie.release_date.substring(0, 4) : 'N/A';
                row.appendChild(cellYear);

                // 4. Rating Cell
                const cellRating = document.createElement('td');
                cellRating.classList.add('col-rating'); // Apply column style
                // Format rating and include vote count
                const rating = movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A';
                cellRating.textContent = `${rating}/10 (${movie.vote_count} votes)`;
                row.appendChild(cellRating);

                // 5. Language Cell
                const cellLang = document.createElement('td');
                cellLang.classList.add('col-lang'); // Apply column style
                // Display language code in uppercase
                cellLang.textContent = movie.original_language ? movie.original_language.toUpperCase() : 'N/A';
                row.appendChild(cellLang);

                // 6. Watch Providers Cell
                const cellProviders = document.createElement('td');
                cellProviders.classList.add('col-providers'); // Apply column style
                const providerListDiv = document.createElement('div');
                providerListDiv.className = 'provider-list'; // Use existing class for styling spans

                // Safely access provider data for the selected country using optional chaining (?.) and bracket notation []
                const selectedCountryProviders = movie.watchProviders?.[watchCountryCode]?.flatrate; // Focus on 'flatrate' (streaming)

                // Check if provider data exists for the selected country
                if (selectedCountryProviders && selectedCountryProviders.length > 0) {
                    // Display provider names
                    selectedCountryProviders.forEach(provider => {
                        const providerSpan = document.createElement('span');
                        providerSpan.textContent = provider.provider_name;
                        providerListDiv.appendChild(providerSpan);
                    });
                    // Add link to TMDb watch options if available
                    const tmdbLink = movie.watchProviders?.[watchCountryCode]?.link;
                    if (tmdbLink) {
                        const linkEl = document.createElement('a');
                        linkEl.href = tmdbLink;
                        linkEl.target = '_blank'; // Open in new tab
                        linkEl.rel = 'noopener noreferrer'; // Security best practice
                        linkEl.textContent = 'More options'; // Shorter text for table
                        linkEl.className = 'text-indigo-600 hover:text-indigo-800 text-xs block mt-1'; // Styling
                        providerListDiv.appendChild(linkEl);
                    }
                } else if (movie.watchProviders === null) {
                     // Indicate if fetching providers failed for this specific movie
                     providerListDiv.innerHTML = `<span class="text-gray-400 text-xs italic">Fetch failed</span>`;
                } else {
                    // Indicate if no providers were found for the selected country
                    providerListDiv.innerHTML = `<span class="text-gray-400 text-xs italic">None found</span>`;
                }
                cellProviders.appendChild(providerListDiv);
                row.appendChild(cellProviders);

                // Append the completed row to the table body
                tbody.appendChild(row);
            });

            // Append the table body to the table
            table.appendChild(tbody);
            // Append the complete table to the results container div
            resultsDiv.appendChild(table);
        }
    </script>

</body>
</html>
